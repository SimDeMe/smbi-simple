<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Matematisk Model Test</title>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        h1 { color: white; border-bottom: 1px solid #555; padding-bottom: 10px; }
        #log { 
            white-space: pre; 
            font-size: 14px; 
            line-height: 1.5;
        }
        .highlight { color: yellow; font-weight: bold; }
        .new-cycle { color: cyan; font-weight: bold; border-top: 1px dashed cyan; margin-top: 10px; display: block;}
        button {
            position: fixed; top: 20px; right: 20px;
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            background: #fff; border: none; font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>Hormon Motor: Matematisk Test</h1>
    <button onclick="runSimulation()">Kør 60 dage</button>
    <div id="log">Tryk på knappen for at beregne tallene...</div>

<script>
    // --- KONFIGURATION AF MODEL ---
    const config = {
        dt: 0.1, // Vi tager lidt større skridt her for at listen ikke bliver uendelig lang
        
        // Nedbrydningsrater (Hvor hurtigt fjerner kroppen hormonet?)
        clearance: {
            fsh: 0.05,
            lh: 0.15,
            est: 0.05,
            prog: 0.05
        },

        // Tærskelværdier
        ovulationThreshold: 40, 
        estrogenTrigger: 25     
    };

    // --- TILSTAND (Vores variable) ---
    let sim = {
        time: 1,           
        fsh: 6,            
        lh: 3,             
        est: 5,            
        prog: 0,           
        
        follicleSize: 1,   
        clSize: 0,         
        
        hasOvulated: false 
    };

    // --- LOGIK-MOTOREN ---
    function updateHormones() {
        
        // 1. DEFINER FEEDBACK STYRKER 
        
        // Negativ feedback
        let inhibition = 1 / (1 + (sim.est * 0.05) + (sim.prog * 3.0)); 
        
        // POSITIV FEEDBACK SWITCH (LH Surge)
        // Hvis østrogen er højt, og progesteron er lavt -> Hypofysen går amok
        let positiveFeedback = 0;
        if (sim.est > config.estrogenTrigger && sim.prog < 2) {
            positiveFeedback = (sim.est - config.estrogenTrigger) * 2.0; 
        }

        // 2. BEREGN ÆNDRINGER 

        // --- FSH ---
        let fshProd = 1.8 * inhibition; // Lidt lavere base rate
        // Hvis progesteron falder (slutning af cyklus), giv FSH et ekstra boost for at starte ny cyklus
        if (sim.prog < 1 && sim.clSize < 2 && sim.hasOvulated) {
             fshProd += 2.0; 
        }

        let fshChange = (fshProd - (sim.fsh * config.clearance.fsh)) * config.dt;

        // --- LH ---
        let lhProd = (1.0 * inhibition) + positiveFeedback;
        let lhChange = (lhProd - (sim.lh * config.clearance.lh)) * config.dt;


        // 3. BIOLOGISKE STRUKTURER

        // --- FOLLIKEL ---
        if (!sim.hasOvulated) {
            // Vokser kun hvis FSH er over et vist niveau
            let growth = 0;
            if (sim.fsh > 2) growth = sim.fsh * 0.08; 
            
            sim.follicleSize += growth * config.dt;
            
            // Folliklen producerer Østrogen
            let targetEst = sim.follicleSize * 3.5;
            let estChange = (targetEst - sim.est) * 0.5 * config.dt;
            sim.est += estChange;
        }

        // --- ÆGLØSNING ---
        if (!sim.hasOvulated && sim.lh > config.ovulationThreshold) {
            logMessage(`<span class="highlight">--- ÆGLØSNING (Dag ${sim.time.toFixed(1)}) --- LH Peak: ${sim.lh.toFixed(1)}</span>`);
            sim.hasOvulated = true;
            sim.follicleSize = 0; 
            sim.clSize = 10;      
            sim.est = 10; // Dykker efter ægløsning
        }

        // --- CORPUS LUTEUM ---
        if (sim.hasOvulated) {
            sim.clSize -= 0.8 * config.dt; // Dør langsomt
            
            if (sim.clSize <= 0) {
                startNewCycle();
            } else {
                // CL producerer Progesteron
                let targetProg = sim.clSize * 1.5;
                let progChange = (targetProg - sim.prog) * 0.2 * config.dt;
                sim.prog += progChange;

                // CL producerer også lidt østrogen (den anden pukkel på grafen)
                sim.est += (sim.clSize * 0.8 - sim.est) * 0.1 * config.dt;
            }
        } else {
            sim.prog -= sim.prog * 0.1 * config.dt;
        }

        // 4. OPDATER VÆRDIER
        sim.fsh += fshChange;
        sim.lh += lhChange;
        sim.time += config.dt;
        
        // Sikkerhedsnet: Ingen negative værdier
        if(sim.fsh < 0) sim.fsh = 0;
        if(sim.lh < 0) sim.lh = 0;
    }

    function startNewCycle() {
        sim.clSize = 0;
        sim.hasOvulated = false; 
        sim.follicleSize = 1;
        logMessage(`<span class="new-cycle">--- NY CYKLUS STARTER (Dag ${sim.time.toFixed(1)}) ---</span>`);
        
        // Vi nulstiller ikke tiden, den fortsætter bare, men biologien starter forfra
    }

    // --- HJÆLPEFUNKTIONER TIL LOGGING ---
    const logDiv = document.getElementById('log');
    function logMessage(msg) {
        logDiv.innerHTML += msg + "\n";
    }

    function runSimulation() {
        logDiv.innerHTML = "Beregner...\n";
        
        // Kør 600 steps (ca 60 dage med dt=0.1)
        for (let i = 0; i < 600; i++) {
            updateHormones();
            
            // Print status hver gang vi passerer en hel dag
            if (Math.abs(sim.time % 1) < config.dt) {
                let day = Math.floor(sim.time);
                let fsh = sim.fsh.toFixed(1).padStart(5, ' ');
                let lh = sim.lh.toFixed(1).padStart(5, ' ');
                let est = sim.est.toFixed(1).padStart(5, ' ');
                let prog = sim.prog.toFixed(1).padStart(5, ' ');
                
                logMessage(`Dag ${day}:  FSH:${fsh} | LH:${lh} | Est:${est} | Prog:${prog}`);
            }
        }
    }

</script>

</body>
</html>